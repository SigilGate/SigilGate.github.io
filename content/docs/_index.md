---
title: "Документация"
description: "Архитектура и устройство сети Sigil Gate"
summary: "Обзор архитектуры, типы нод, принципы маскировки и устойчивости к DPI"
weight: 10
---

{{< lead >}}
**Sigil Gate** — приватная сеть с архитектурой «ядро-периферия», устойчивая к обнаружению системами DPI и активному зондированию.
{{< /lead >}}

## Архитектура

Сеть **Sigil Gate** построена по модели «ядро-периферия» — плотно связанное ядро из Core-нод и периферия из Entry-нод, подключенных к ядру.

### Принципы

- **Устойчивость к DPI** — трафик на каждом участке сети неотличим от легитимной HTTPS-активности.
- **Децентрализация** — отсутствие единой точки отказа в плоскости данных; выход одного узла не нарушает работу остальных.
- **Масштабируемость** — сеть растет добавлением новых Entry- и Core-нод без перестройки существующей инфраструктуры.
- **Адаптивная топология** — сеть гибко реагирует на изменения: вывод узлов, перераспределение нагрузки, смена маршрутов.
- **Простота эксплуатации** — типовые операции (развертывание, ротация, мониторинг) автоматизированы и выполняются скриптами с управляющего узла.
- **Федерация** — сеть способна принимать новые узлы и объединяться с другими сетями, построенными на той же архитектуре.

### Сущности

Система состоит из четырех типов сущностей:

| Тип | Роль | Плоскость | Расположение | Жизненный цикл |
|-----|------|-----------|-------------|----------------|
| [Root-нода]({{< ref "docs/nodes/root" >}}) | Центр управления, PKI, развертывание | Управление | Любой сегмент | Долгоживущая, критическая |
| [Core-нода]({{< ref "docs/nodes/core" >}}) | Ядро сети, маршрутизация трафика в интернет | Данные + управление | Вне региона | Долгоживущая |
| [Entry-нода]({{< ref "docs/nodes/entry" >}}) | Входной узел, прием клиентских подключений | Данные | Внутри региона | Расходная, ротируемая |
| [Клиент]({{< ref "docs/nodes/client" >}}) | Устройство пользователя | Данные | Внутри региона | — |

{{< mermaid >}}
graph TD
    Root["Root-нода<br/><small>управление, PKI</small>"]
    Core["Core-нода<br/><small>ядро, маршрутизация</small>"]
    Entry["Entry-нода<br/><small>периферия, прием подключений</small>"]
    Client["Клиент<br/><small>устройство пользователя</small>"]

    Root -->|"SSH"| Core
    Root -->|"SSH"| Entry
    Client -->|"VLESS + gRPC"| Entry
    Entry -->|"VLESS + gRPC"| Core

    style Root fill:#7c3aed,color:#fff,stroke:#6d28d9
    style Core fill:#1d4ed8,color:#fff,stroke:#1e40af
    style Entry fill:#0891b2,color:#fff,stroke:#0e7490
    style Client fill:#64748b,color:#fff,stroke:#475569
{{< /mermaid >}}

## Плоскость данных

Пользовательский трафик проходит через цепочку: Клиент → Entry-нода → Core-нода → Интернет. Root-нода не участвует в передаче данных.

{{< mermaid >}}
graph TD
    Client["Клиент<br/><small>внутри региона</small>"]
    Entry["Entry-нода<br/><small>внутри региона</small>"]
    Core["Core-нода<br/><small>вне региона</small>"]
    Internet["Интернет"]

    Client -->|"VLESS + gRPC<br/>TLS 1.3"| Entry
    Entry -->|"VLESS + gRPC<br/>TLS 1.3"| Core
    Core --> Internet

    style Client fill:#64748b,color:#fff,stroke:#475569
    style Entry fill:#0891b2,color:#fff,stroke:#0e7490
    style Core fill:#1d4ed8,color:#fff,stroke:#1e40af
    style Internet fill:#374151,color:#fff,stroke:#1f2937
{{< /mermaid >}}

### Топология «ядро-периферия»

Ядро сети образовано Core-нодами, которые связаны между собой (mesh). Периферия — Entry-ноды — подключается к ядру, но не связана между собой.

Для передачи данных Entry-нода может быть связана с **несколькими** Core-нодами, но не более чем с **третью** от общего числа Core-нод. Это ограничение реализует принцип минимальной связности: при компрометации Entry-ноды раскрывается лишь малая часть ядра сети.

### Маскировка трафика

На каждом участке сети трафик неотличим от легитимной HTTPS-активности:

| Участок | Что видит наблюдатель | Реальность |
|---------|----------------------|------------|
| Клиент → Entry | HTTPS-запросы к обычному сайту | VPN-туннель (VLESS + gRPC) |
| Entry → Core | gRPC-вызовы к API микросервисов | VPN-туннель (VLESS + gRPC) |

На обоих участках:

- TLS 1.3 handshake — стандартный, неотличимый от обычного;
- валидный сертификат Let's Encrypt;
- при обращении без VLESS-заголовков сервер отдает сайт-прикрытие (HTTP 200 OK).

### Защита от активного зондирования

На каждом узле сети в плоскости данных сервер Xray расположен за веб-сервером. При обращении на любой URL без правильных VLESS-заголовков веб-сервер возвращает сайт-прикрытие. Наблюдатель не может отличить «секретный путь» от «обычной страницы» — нет характерных ошибок, редиректов или отказов.

### Протокольный стек

{{< mermaid >}}
graph TB
    subgraph "Протокольный стек"
        TLS["TLS 1.3<br/><small>Let's Encrypt</small>"]
        gRPC["gRPC (HTTP/2)"]
        VLESS["VLESS"]
    end

    TLS --- gRPC
    gRPC --- VLESS

    style TLS fill:#7c3aed,color:#fff,stroke:#6d28d9
    style gRPC fill:#2563eb,color:#fff,stroke:#1d4ed8
    style VLESS fill:#1d4ed8,color:#fff,stroke:#1e40af
{{< /mermaid >}}

| Уровень | Технология | Назначение |
|---------|-----------|------------|
| Шифрование | TLS 1.3 | Шифрование канала, валидный сертификат |
| Транспорт | gRPC (HTTP/2) | Мультиплексирование, маскировка под API |
| Протокол | VLESS | Легковесный прокси-протокол |

Рассмотрев альтернативы, gRPC выбран как единственный транспорт:

- устойчив к обнаружению (в отличие от XHTTP);
- высокая производительность (в отличие от WebSocket);
- трафик идентичен легитимным gRPC API микросервисов.

### Динамическая ротация путей

Core-ноды периодически генерируют новые случайные gRPC-пути на участке Entry → Core. Это затрудняет статистический анализ трафика. Клиентские пути при этом не затрагиваются.

## Администрирование

### Плоскость управления

Root-нода администрирует всю сеть по SSH. Доступ — однонаправленный: Root имеет доступ ко всем нодам, обратный доступ запрещен.

{{< mermaid >}}
graph TD
    Root["Root-нода<br/><small>управление, PKI</small>"]

    Core1["Core-нода #1"]
    Core2["Core-нода #2"]

    Entry1["Entry-нода A"]
    Entry2["Entry-нода B"]
    Entry3["Entry-нода C"]

    Root -->|SSH| Core1
    Root -->|SSH| Core2
    Root -->|SSH| Entry1
    Root -->|SSH| Entry2
    Root -->|SSH| Entry3

    Core1 ---|"mesh"| Core2

    style Root fill:#7c3aed,color:#fff,stroke:#6d28d9
    style Core1 fill:#1d4ed8,color:#fff,stroke:#1e40af
    style Core2 fill:#1d4ed8,color:#fff,stroke:#1e40af
    style Entry1 fill:#0891b2,color:#fff,stroke:#0e7490
    style Entry2 fill:#0891b2,color:#fff,stroke:#0e7490
    style Entry3 fill:#0891b2,color:#fff,stroke:#0e7490
{{< /mermaid >}}

### Административная привязка

Каждая Entry-нода в каждый момент времени **административно** закреплена за одной Core-нодой. Core-нода отвечает за конфигурирование, ротацию путей и мониторинг своих Entry-нод.

Это образует древовидную структуру в плоскости управления:

{{< mermaid >}}
graph TD
    Core1["Core-нода #1"]
    Core2["Core-нода #2"]

    E1["Entry A"]
    E2["Entry B"]
    E3["Entry C"]
    E4["Entry D"]
    E5["Entry E"]

    Core1 --> E1
    Core1 --> E2
    Core1 --> E3
    Core2 --> E4
    Core2 --> E5

    Core1 ---|"mesh"| Core2

    style Core1 fill:#1d4ed8,color:#fff,stroke:#1e40af
    style Core2 fill:#1d4ed8,color:#fff,stroke:#1e40af
    style E1 fill:#0891b2,color:#fff,stroke:#0e7490
    style E2 fill:#0891b2,color:#fff,stroke:#0e7490
    style E3 fill:#0891b2,color:#fff,stroke:#0e7490
    style E4 fill:#0891b2,color:#fff,stroke:#0e7490
    style E5 fill:#0891b2,color:#fff,stroke:#0e7490
{{< /mermaid >}}

Core-ноды могут передавать свои Entry-ноды друг другу — например, для вывода Core-ноды из ротации на обслуживание. Это обеспечивает эксплуатационную гибкость без потери связности.

### Управление с Core-нод

Помимо Root-ноды, типовые операции по управлению сетью могут выполняться с любой Core-ноды: добавление новых Entry-нод, регистрация пользователей, ротация путей. Это позволяет администрировать сеть без постоянного доступа к Root-ноде.

### Инфраструктура открытых ключей (PKI)

Сеть использует трехуровневую иерархию сертификатов:

{{< mermaid >}}
graph TD
    RootCA["Root CA<br/><small>Root-нода</small>"]
    IntCA1["Промежуточный CA<br/><small>Core-нода #1</small>"]
    IntCA2["Промежуточный CA<br/><small>Core-нода #2</small>"]
    Cert1["Сертификат<br/><small>Entry-нода A</small>"]
    Cert2["Сертификат<br/><small>Entry-нода B</small>"]
    Cert3["Сертификат<br/><small>Entry-нода C</small>"]

    RootCA --> IntCA1
    RootCA --> IntCA2
    IntCA1 --> Cert1
    IntCA1 --> Cert2
    IntCA2 --> Cert3

    style RootCA fill:#7c3aed,color:#fff,stroke:#6d28d9
    style IntCA1 fill:#1d4ed8,color:#fff,stroke:#1e40af
    style IntCA2 fill:#1d4ed8,color:#fff,stroke:#1e40af
    style Cert1 fill:#0891b2,color:#fff,stroke:#0e7490
    style Cert2 fill:#0891b2,color:#fff,stroke:#0e7490
    style Cert3 fill:#0891b2,color:#fff,stroke:#0e7490
{{< /mermaid >}}

| Сертификат | Где хранится | Срок жизни | Отзыв |
|------------|-------------|------------|-------|
| Root CA | Root-нода | Долгосрочный | Ручной, критический инцидент |
| Промежуточный CA | Core-нода | Долгосрочный | Ручной, с Root-ноды |
| Сертификат Entry | Entry-нода | Часы / дни | Автоматический |

### Компрометация и реагирование

{{< alert >}}
Под **компрометацией** ноды понимается не только несанкционированный доступ к ноде, но и обнаружение и блокировка системами DPI. Признаки компрометации — потеря HTTPS-связности между Entry- и Core-нодами при сохранении SSH-доступа, или существенная деградация канала связи.
{{< /alert >}}

#### Компрометация Entry-ноды

1. Вывести скомпрометированную Entry-ноду из оборота.
2. Если общее количество Core-нод > 2 — вывести Core-ноды, известные этой Entry-ноде.
3. Перевыпустить сертификаты для затронутых компонентов.

#### Компрометация Root-ноды (критический инцидент)

1. Немедленно отозвать все SSH-ключи на всех нодах.
2. Перегенерировать Root CA.
3. Перевыпустить все сертификаты Core-нод и Entry-нод.
4. Развернуть новую Root-ноду.

## Глоссарий

| Термин | Определение |
|--------|-------------|
| Core-periphery | Сетевая топология с плотно связанным ядром и слабо связанной периферией |
| Root-нода | Центр управления сетью и Root CA; не участвует в трафике |
| Core-нода | Узел ядра сети; маршрутизирует трафик в интернет, промежуточный CA |
| Entry-нода | Входной узел периферии; принимает клиентские подключения |
| VLESS | Легковесный прокси-протокол семейства V2Ray |
| gRPC | Высокопроизводительный RPC-фреймворк на базе HTTP/2 |
| DPI | Deep Packet Inspection — глубокий анализ сетевых пакетов |
| Active probing | Техника DPI: активное подключение к серверу для проверки протокола |
| Fallback | Резервный ответ (сайт-прикрытие) при отсутствии VLESS-заголовков |
| PKI | Public Key Infrastructure — инфраструктура открытых ключей |
| Soft affinity | Условная привязка Entry-ноды к Core-ноде, допускающая переназначение |
